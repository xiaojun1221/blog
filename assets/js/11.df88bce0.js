(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{523:function(s,n,a){"use strict";a.r(n);var e=a(3),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"一、环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、环境准备"}},[s._v("#")]),s._v(" 一、环境准备")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("两台机器，分别安装CentOS7和Nginx，并可以互相ping通，实例如下：")])]),s._v(" "),a("li",[a("p",[s._v("RabbitMQ三台主机组成为镜像集群，搭建过程，可以参考之前写的"),a("a",{attrs:{href:"http://192.168.1.50:8000/project-8/doc-12/",target:"_blank",rel:"noopener noreferrer"}},[s._v("《CentOS7搭建RabbitMq高可用集群(镜像模式)》"),a("OutboundLink")],1)]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("主机名")]),s._v(" "),a("th",[s._v("实例ip")]),s._v(" "),a("th",[s._v("说明")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("ng1.node.com")]),s._v(" "),a("td",[s._v("10.27.10.221")]),s._v(" "),a("td",[s._v("nginx节点1")])]),s._v(" "),a("tr",[a("td",[s._v("ng2.node.com")]),s._v(" "),a("td",[s._v("10.27.10.222")]),s._v(" "),a("td",[s._v("nginx节点2")])]),s._v(" "),a("tr",[a("td",[s._v("rabbit0")]),s._v(" "),a("td",[s._v("10.27.10.230")]),s._v(" "),a("td",[s._v("mq主节点")])]),s._v(" "),a("tr",[a("td",[s._v("rabbit1")]),s._v(" "),a("td",[s._v("10.27.10.231")]),s._v(" "),a("td",[s._v("mq从节点1")])]),s._v(" "),a("tr",[a("td",[s._v("rabbit2")]),s._v(" "),a("td",[s._v("10.27.10.232")]),s._v(" "),a("td",[s._v("mq从节点2")])]),s._v(" "),a("tr",[a("td",[s._v("ng.vm.com")]),s._v(" "),a("td",[s._v("10.27.10.239")]),s._v(" "),a("td",[s._v("虚拟IP")])])])])]),s._v(" "),a("li",[a("p",[s._v("修改两个台器上的hosts文件")])])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("10.27.10.230    rabbit0\n10.27.10.231    rabbit1\n10.27.10.232    rabbit2\n10.27.10.221    ng1.node.com\n10.27.10.222    ng2.node.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"二、安装nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、安装nginx"}},[s._v("#")]),s._v(" 二、安装Nginx")]),s._v(" "),a("p",[s._v("安装脚本")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("pwd")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nginx_home")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/redis\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -f "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/soft/nginx-1.19.5.tar.gz "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" nginx安装包不存在----下载安装包"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/soft/nginx-1.19.5.tar.gz http://nginx.org/download/nginx-1.19.5.tar.gz\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 下载完成\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 解压nginx安装包\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -zxvf "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/soft/nginx-1.19.5.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 移动nginx\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" nginx-1.19.5 /usr/local/nginx-1.19.5\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 移动完成\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 切换目录到/usr/local/nginx下\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/nginx-1.19.5\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("  -d /usr/local/nginx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /usr/local/nginx\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 开始编译\n./configure\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" -j8  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 编译安装完成\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf  /usr/local/nginx-1.19.5\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 启动nginx\nnginx\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 开放端口\nfirewall-cmd --zone"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("public --add-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/tcp --permanent\nfirewall-cmd --reload\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" 开启成功\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$path")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h2",{attrs:{id:"三、开始配置两个-或多个-相同的nginx节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、开始配置两个-或多个-相同的nginx节点"}},[s._v("#")]),s._v(" 三、开始配置两个(或多个)相同的nginx节点")]),s._v(" "),a("ul",[a("li",[s._v("在两台机器上均做相同的nginx配置，即：\n"),a("ul",[a("li",[s._v("开启一个反向代理，代理所有请求，由nginx轮询去处理")])])]),s._v(" "),a("li",[s._v("核心配置，在http代码段位中增加")])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("\tupstream backend {\n        server rabbit0:15672 weight=1 max_fails=3 fail_timeout=20s;\n        server rabbit1:15672 weight=1 max_fails=3 fail_timeout=20s;\n        server rabbit2:15672 weight=1 max_fails=3 fail_timeout=20s;\n    }\n    server {\n        listen       15672;\n        server_name  ng1.node.com;\n        location / {\n                proxy_pass http://backend;\n                proxy_set_header Host $host:$proxy_port;\n                proxy_set_header X-Forwarded-For $remote_addr;\n        }\n    }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("ul",[a("li",[s._v("整体配置如下：")])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@ng2 install]# vim /etc/nginx/nginx.conf\nuser  nginx;\nworker_processes  1;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  $remote_addr - $remote_user [$time_local] $request \n                      $status $body_bytes_sent $http_referer \n                      $http_user_agent $http_x_forwarded_for;\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    include /etc/nginx/conf.d/*.conf;\n    upstream backend {\n        server rabbit0:15672 weight=1 max_fails=3 fail_timeout=20s;\n        server rabbit1:15672 weight=1 max_fails=3 fail_timeout=20s;\n        server rabbit2:15672 weight=1 max_fails=3 fail_timeout=20s;\n    }\n    server {\n        listen       15672;\n        server_name  ng1.node.com;\n        location / {\n                proxy_pass http://backend;\n                proxy_set_header Host $host:$proxy_port;\n                proxy_set_header X-Forwarded-For $remote_addr;\n        }\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br")])]),a("ul",[a("li",[s._v("启动Nginx")])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("service nginx restart\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("p",[s._v("访问任意一个节点，以查看效果：")]),s._v(" "),a("ul",[a("li",[s._v("可以看到，这两个节点除了IP不同，其功能都一模一样，都可以正常代理到后方三个mq服务，实际上这两台nginx服务器，也就是这么配置的")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("但目前只能说有两个功能一样的nginx节点，但并不高可用的，因为这两个节点都无法感知对方是否挂掉，更不可能说挂掉以后自已如何接替")])])])]),s._v(" "),a("h2",{attrs:{id:"四、什么是keepalived"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、什么是keepalived"}},[s._v("#")]),s._v(" 四、什么是keepalived")]),s._v(" "),a("ul",[a("li",[s._v("keepalived：基于虚拟路由冗余协议(VRRP)，能够虚拟出一个IP对外暴露，当有节点出问题时，会进行选举操作进行故障转移(主从模式)")])]),s._v(" "),a("h2",{attrs:{id:"五、使用keepalived使多个节点自动进行故障转移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、使用keepalived使多个节点自动进行故障转移"}},[s._v("#")]),s._v(" 五、使用keepalived使多个节点自动进行故障转移")]),s._v(" "),a("p",[s._v("安装keepalive ，如下")]),s._v(" "),a("h1",{attrs:{id:"_5-1安装包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1安装包"}},[s._v("#")]),s._v(" 5.1安装包")]),s._v(" "),a("p",[s._v("http://www.keepalived.org/software/keepalived-2.0.20.tar.gz\ntar zxvf keepalived-2.0.20.tar.gz")]),s._v(" "),a("h1",{attrs:{id:"_5-2、编译安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2、编译安装"}},[s._v("#")]),s._v(" 5.2、编译安装")]),s._v(" "),a("p",[s._v("解压\ntar -xzvf keepalived-2.0.16.tar.gz\ncd keepalived-2.0.16\n执行配置，指定路径\n./configure --prefix=/usr/local/keepalived\n编译\nmake  make install\n拷贝源码中的keepalived-2.0.20/keepalived/etc/init.d/keepalived 到 /etc/init.d/\ncp /usr/local/keepalived-2.0.20/keepalived/etc/init.d/keepalived /etc/init.d/\n拷贝编译后的keepalived/etc/sysconfig/keepalived 到 /etc/sysconfig/\ncp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/\n创建文件夹\nmkdir /etc/keepalived\n把配置文件移到文件夹中\ncp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/\n把执行文件移动到/usr/sbin/\ncp /usr/local/keepalived/sbin/keepalived /usr/sbin/")]),s._v(" "),a("h1",{attrs:{id:"_5-3、将keepalived添加到开机启动服务中，并进行测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3、将keepalived添加到开机启动服务中，并进行测试"}},[s._v("#")]),s._v(" 5.3、将keepalived添加到开机启动服务中，并进行测试")]),s._v(" "),a("p",[s._v("chkconfig keepalived on\nchkconfig --list | grep keepalived\nsudo service keepalived restart")]),s._v(" "),a("p",[s._v("**注意：**需要修改keepalived启动文件，否则可能会出现stop命令无法停止的情况(注释掉killMode这一行)")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ng2 system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /usr/lib/systemd/system/keepalived.service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("LVS and VRRP High Availability Monitor\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("After")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("syslog.target network-online.target\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("forking\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PIDFile")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/run/keepalived.pid\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#注释掉killMode这一行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#KillMode=process")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EnvironmentFile")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-/etc/sysconfig/keepalived\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/sbin/keepalived "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KEEPALIVED_OPTIONS")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecReload")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/bin/kill -HUP "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MAINPID")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("修改配置文件，指定keepalived的日志文件，默认是会打印在/var/log/message中，这在查看时非常困难，将文件中的KEEPALIVED_OPTIONS值改为-D -d -S 0")]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@ng2 src]# vim /etc/sysconfig/keepalived\n\nKEEPALIVED_OPTIONS=-D -d -S 0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@ng2 src]# vim /etc/rsyslog.conf \n#在文件末尾追加，指定keepalilved的日志文件路径\nlocal0.*           /var/log/keepalived.log\n\n#重启日志记录服务\n[root@ng2 src]# systemctl restart rsyslog \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("ul",[a("li",[s._v("对keepalived进行配置")])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/etc/keepalived\n[root@centos6-1 keepalived]# cp keepalived.conf keepalived.conf.bak\n[root@centos6-1 keepalived]# vim keepalived.conf\n\n! Configuration File for keepalived\n#全局配置\nglobal_defs {\n\t#当发生异常切换时，发送警告到指定的邮箱，需要开启SendMail服务\n\tnotification_email {\n\t\tacassen@firewall.loc\n\t\tfailover@firewall.loc\n\t\tsysadmin@firewall.loc\n\t}\n\t#邮件的发件人\n\tnotification_email_from Alexandre.Cassen@firewall.loc\n\t#smtp服务器地址\n\tsmtp_server 192.168.200.1\n\t#smtp连接超时时间\n\tsmtp_connect_timeout 30\n}\n\n#指定同步服务绑定的VRRP实例\nvrrp_instance VI_1 {\n\t#指定该keepalived节点的初始状态\n    state MASTER\n\t#指定vrrp实例绑定的网卡接口，用于发送VRRP包\n    interface ens33\n\t#指定VRRP实例ID\n    virtual_router_id 51\n\t#指定优先级，优先级高的将成为MASTER\n    priority 150\n\t#设置为不抢占。默认是抢占的\n\tnopreempt\n    advert_int 1\n    authentication {\n\t\t#指定认证方式为密码认证\n        auth_type PASS\n\t\t#密码值\n        auth_pass 123456\n    }\n\t\n    virtual_ipaddress {\n\t\t#指定的虚拟IP地址\n        10.27.10.239 master ens33\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br")])]),a("ul",[a("li",[s._v("配置完成以后重启keepalived服务，使用ip a 查看，会发现网卡中多了一个虚拟IP：10.27.10.239，即是keepalived中指定的虚拟ip，并且可以ping通这个ip，")])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@localhost keepalived]# service keepalived restart\nRedirecting to /bin/systemctl restart keepalived.service\n[root@localhost keepalived]# ip a\n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:0c:29:d5:de:eb brd ff:ff:ff:ff:ff:ff\n    inet 10.27.10.221/23 brd 10.27.11.255 scope global noprefixroute ens33\n       valid_lft forever preferred_lft forever\n    inet 10.27.10.239/32 scope global ens33\n       valid_lft forever preferred_lft forever\n    inet6 fe80::2cc:f27b:20e7:52a/64 scope link noprefixroute \n       valid_lft forever preferred_lft forever\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("ul",[a("li",[s._v("从节点的配置和主节点一样，只是state设置为BACKUP(主节点设的是MASTER):")])]),s._v(" "),a("p",[s._v("> #指定该keepalived节点的初始状态\n>  state BACKUP")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("配置完以后，重启keepalived，使用ip a 查看，会发现并没有产生新的虚拟IP，这是因为备份节点，只有在主节点挂掉以后，虚拟IP才会转移过来")])]),s._v(" "),a("li",[a("p",[s._v("测试主节点是否成功：使用虚拟IP访问RabbitMQ http://ng.vm.com:15672/  ，发现可以正常访问，说明keepalived虚拟IP生效成功转移到主节点")])]),s._v(" "),a("li",[a("p",[s._v("再关掉主节点的keepalived,再进行访问")])])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@localhost keepalived]# ps -ef | grep keepalived\nroot      71265      1  0 11:19 ?        00:00:00 /usr/sbin/keepalived -D\nroot      71266  71265  0 11:19 ?        00:00:00 /usr/sbin/keepalived -D\nroot      71267  71265  0 11:19 ?        00:00:00 /usr/sbin/keepalived -D\nroot      71648  63548  0 11:26 pts/1    00:00:00 grep --color=auto keepalived\n[root@localhost keepalived]# kill -9 71265\n[root@localhost keepalived]# ps -ef | grep keepalived\nroot      71658  63548  0 11:26 pts/1    00:00:00 grep --color=auto keepalived\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("ul",[a("li",[s._v("发现仍然可以访问，然后查看备机的ip,会发现10.27.10.239这个虚拟IP漂移到了备机上面，"),a("strong",[s._v("至此，完成了keepalived的自动故障转移")])])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@ng2 system]# ip a\n\n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:0c:29:60:36:22 brd ff:ff:ff:ff:ff:ff\n    inet 10.27.10.222/23 brd 10.27.11.255 scope global noprefixroute ens33\n       valid_lft forever preferred_lft forever\n    inet 10.27.10.239/32 scope global ens33\n       valid_lft forever preferred_lft forever\n    inet6 fe80::1cf2:b088:7d41:b82f/64 scope link noprefixroute \n       valid_lft forever preferred_lft forever\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h2",{attrs:{id:"六、配置检查脚本使keepalived可以感知nginx的状态，并做故障转移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、配置检查脚本使keepalived可以感知nginx的状态，并做故障转移"}},[s._v("#")]),s._v(" 六、配置检查脚本使keepalived可以感知nginx的状态，并做故障转移")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("上面的操作，虽然实现了故障转移，但是是基于keepalived故障的，也就是说只有keepalived挂掉，才会转移到备机上，而我们需要的是nginx挂掉以后就做转移，而不是keepalived")])]),s._v(" "),a("li",[a("p",[s._v("编写nginx检测脚本")])])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@ng2 script]# vim /usr/local/src/check_nginx_pid.sh\n\n#!/bin/bash\n#获取nginx进程的数量\ncounter=$(ps -C nginx --no-heading|wc -l)\n#如果nginx进程数量为0(没有启动或挂掉)\necho monitor running\nif [ ${counter} = 0 ]; then\n        #则尝试启动一下nginx\n    systemctl start nginx.service\n    #等待2秒\n    sleep 2\n    #再查询nginx进程数量\n    counter=$(ps -C nginx --no-heading|wc -l)\n    #如果nginx进程数仍然为0\n    if [ ${counter} = 0 ]; then\n        #则停止keepalived进程，迫使虚拟IP转移到备机上，完成故障转移（该命令需要根据实际情况修改）\n        systemctl stop keepalived.service\n    fi\nfi\n\n\n#设置为为可执行文件\n[root@ng2 src]# chmod +x check_nginx_pid.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("ul",[a("li",[s._v("将检查脚本配置到主机和备机上，插入"),a("strong",[s._v("vrrp_script chk_http_port")]),s._v("和"),a("strong",[s._v("track_script")]),s._v("代码段，整个配置如下")])]),s._v(" "),a("div",{staticClass:"language-.sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@ng1 src]# vim /etc/keepalived/keepalived.conf\n\n! Configuration File for keepalived\n\n#全局配置\nglobal_defs {\n        #当发生异常切换时，发送警告到指定的邮箱（多个），需要开启SendMail服务\n        notification_email {\n                acassen@firewall.loc\n                failover@firewall.loc\n                sysadmin@firewall.loc\n        }\n        #邮件的发件人\n        notification_email_from Alexandre.Cassen@firewall.loc\n        #smtp服务器地址\n        smtp_server 192.168.200.1\n        #smtp连接超时时间\n        smtp_connect_timeout 30\n}\n\n#脚本定义\nvrrp_script check_nginx {\n    #检查脚本   \n    script /usr/local/src/check_nginx_pid.sh\n    #每3秒执行一次脚本（如果脚本中有sleep，则此时间一定要大于脚本中的sleep时间）\n    interval 3\n    #权重(需要进行特殊选举时使用，一般不使用)                       \n    # weight 2\n}\n\n#指定同步服务绑定的VRRP实例\nvrrp_instance VI_1 {\n    #指定该keepalived节点的初始状态\n    state MASTER\n    #指定vrrp实例绑定的网卡接口，用于发送VRRP包\n    interface ens33\n    #指定VRRP实例ID\n    virtual_router_id 51\n    #指定优先级，优先级高的将成为MASTER\n    priority 150\n    #设置为不抢占。默认是抢占的\n    nopreempt\n    advert_int 1\n    authentication {\n\t\t#指定认证方式为密码认证\n        auth_type PASS\n        #密码值\n        auth_pass 123456\n    }\n    \n    #定义实例中需要使用的脚本\n    track_script {\n        #需要检测的脚本\n        check_nginx\n\t}\n\n    virtual_ipaddress {\n        #指定的虚拟IP地址\n        10.27.10.239\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br")])]),a("ul",[a("li",[s._v("进行测试，关掉主节点的nginx服务(并且不启动)，发现过一会，keeplived服务被停止，虚拟IP漂移到另一台机器上，完成了nginx的故障转移。")])]),s._v(" "),a("h2",{attrs:{id:"至此，nginx高可用完成，该模式为keepalived的主从模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#至此，nginx高可用完成，该模式为keepalived的主从模式"}},[s._v("#")]),s._v(" 至此，nginx高可用完成，该模式为keepalived的主从模式")]),s._v(" "),a("h2",{attrs:{id:"七、主从模式总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七、主从模式总结"}},[s._v("#")]),s._v(" 七、主从模式总结")]),s._v(" "),a("p",[s._v("整个过程为：")]),s._v(" "),a("ol",[a("li",[s._v("首先得有两个或多个一模一样的nginx节点")]),s._v(" "),a("li",[s._v("每个节点上安装keepalived，并且使用同一个虚拟ip(暴露给应用服务使用)，这些节点上，只有一个节点会有虚拟IP，当访问时也就访问到这个节点上。")]),s._v(" "),a("li",[s._v("keepalived每次会定时运行监测脚本")]),s._v(" "),a("li",[s._v("如果keepalived挂掉或被停止掉，会将虚拟IP转移至某一个从节点使其来提供服务，所以第3步就是利用这一点，发现nginx故障时，停止掉keepalived，触发故障转移，同理可以通过改写脚本，几乎可以对任何应用做主从的高可用")]),s._v(" "),a("li",[s._v("可以配置警告邮箱，当有故障发生时，可以获得通知，并处理故障。如果故障不处理，当所有节点都挂掉后，服务也就不可用了。")]),s._v(" "),a("li",[s._v("还可以做双主模式，但是这样会有两个虚拟IP出现，不便统一暴露给应用程序")]),s._v(" "),a("li",[s._v("以上是基本的高可用配置\n"),a("ul",[a("li",[s._v("其它配置说明参考：https://github.com/huweihuang/linux-notes/blob/master/keepalived/keepalived-conf.md")]),s._v(" "),a("li",[s._v("更多的配置可以参考官方配置说明(英文)：https://www.keepalived.org/manpage.html")])])])])])}),[],!1,null,null,null);n.default=t.exports}}]);