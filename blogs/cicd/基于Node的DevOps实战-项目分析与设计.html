<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于 Node 的 DevOps 实战(三)———分析与设计 | jun的个人空间</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="A simple and beautiful vuepress blog theme .">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/blog/assets/css/0.styles.22e22db1.css" as="style"><link rel="preload" href="/blog/assets/js/app.2e9aaf02.js" as="script"><link rel="preload" href="/blog/assets/js/3.df7e12f5.js" as="script"><link rel="preload" href="/blog/assets/js/1.71a2a4d1.js" as="script"><link rel="preload" href="/blog/assets/js/19.c7295ef8.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.06cfad2a.js"><link rel="prefetch" href="/blog/assets/js/11.df88bce0.js"><link rel="prefetch" href="/blog/assets/js/12.041115a7.js"><link rel="prefetch" href="/blog/assets/js/13.f0185e2a.js"><link rel="prefetch" href="/blog/assets/js/14.5a045b81.js"><link rel="prefetch" href="/blog/assets/js/15.7164e1d7.js"><link rel="prefetch" href="/blog/assets/js/16.f9c02261.js"><link rel="prefetch" href="/blog/assets/js/17.d889275f.js"><link rel="prefetch" href="/blog/assets/js/18.11d93686.js"><link rel="prefetch" href="/blog/assets/js/20.ef0bf1ef.js"><link rel="prefetch" href="/blog/assets/js/21.c0808f41.js"><link rel="prefetch" href="/blog/assets/js/22.411bd3f9.js"><link rel="prefetch" href="/blog/assets/js/23.18a8e710.js"><link rel="prefetch" href="/blog/assets/js/24.ca6e4b20.js"><link rel="prefetch" href="/blog/assets/js/25.0d72f462.js"><link rel="prefetch" href="/blog/assets/js/26.c4c011ae.js"><link rel="prefetch" href="/blog/assets/js/27.eb3de618.js"><link rel="prefetch" href="/blog/assets/js/28.f8e2a1e2.js"><link rel="prefetch" href="/blog/assets/js/29.f03180e4.js"><link rel="prefetch" href="/blog/assets/js/30.36ab1f30.js"><link rel="prefetch" href="/blog/assets/js/31.eeacc110.js"><link rel="prefetch" href="/blog/assets/js/32.20a67723.js"><link rel="prefetch" href="/blog/assets/js/33.eedb8eae.js"><link rel="prefetch" href="/blog/assets/js/34.5746a48f.js"><link rel="prefetch" href="/blog/assets/js/35.5aae019c.js"><link rel="prefetch" href="/blog/assets/js/36.8cf983a3.js"><link rel="prefetch" href="/blog/assets/js/37.52c37ca6.js"><link rel="prefetch" href="/blog/assets/js/38.a2ae90d0.js"><link rel="prefetch" href="/blog/assets/js/39.491dc017.js"><link rel="prefetch" href="/blog/assets/js/4.868230a6.js"><link rel="prefetch" href="/blog/assets/js/40.aa1410cd.js"><link rel="prefetch" href="/blog/assets/js/5.ea5f743c.js"><link rel="prefetch" href="/blog/assets/js/6.c6d16241.js"><link rel="prefetch" href="/blog/assets/js/7.e9233ad5.js"><link rel="prefetch" href="/blog/assets/js/8.7ae95209.js"><link rel="prefetch" href="/blog/assets/js/9.3304f7f8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.22e22db1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-945f89ac><div data-v-945f89ac><div id="loader-wrapper" class="loading-wrapper" data-v-2c578df8 data-v-945f89ac data-v-945f89ac><div class="loader-main" data-v-2c578df8><div data-v-2c578df8></div><div data-v-2c578df8></div><div data-v-2c578df8></div><div data-v-2c578df8></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-3dc17307 data-v-945f89ac data-v-945f89ac><h3 class="title" style="display:none;" data-v-3dc17307 data-v-3dc17307>jun的个人空间</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-3dc17307 data-v-3dc17307><input type="password" value="" data-v-3dc17307> <span data-v-3dc17307>Konck! Knock!</span> <button data-v-3dc17307>OK</button></label> <div class="footer" style="display:none;" data-v-3dc17307 data-v-3dc17307><span data-v-3dc17307><i class="iconfont reco-theme" data-v-3dc17307></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-3dc17307>vuePress-theme-reco</a></span> <span data-v-3dc17307><i class="iconfont reco-copyright" data-v-3dc17307></i> <a data-v-3dc17307><span data-v-3dc17307>jun</span>
            
          <span data-v-3dc17307>2017 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-945f89ac><header class="navbar" data-v-945f89ac><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="jun的个人空间" class="logo"> <span class="site-name">jun的个人空间</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/系统教程/" class="nav-link"><i class="iconfont undefined"></i>
  系统教程
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/环境构建/" class="nav-link"><i class="iconfont undefined"></i>
  环境构建
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/K8S/" class="nav-link"><i class="iconfont undefined"></i>
  K8S
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/前端/" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/工具/" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/性能优化/" class="nav-link"><i class="iconfont undefined"></i>
  性能优化
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      文档
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/docs/theme-reco/" class="nav-link"><i class="iconfont undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-945f89ac></div> <aside class="sidebar" data-v-945f89ac><div class="personal-info-wrapper" data-v-661bee24><img src="/blog/avatar.jpg" alt="author-avatar" class="personal-img" data-v-661bee24> <h3 class="name" data-v-661bee24>
    jun
  </h3> <div class="num" data-v-661bee24><div data-v-661bee24><h3 data-v-661bee24>26</h3> <h6 data-v-661bee24>文章</h6></div> <div data-v-661bee24><h3 data-v-661bee24>31</h3> <h6 data-v-661bee24>标签</h6></div></div> <hr data-v-661bee24></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/系统教程/" class="nav-link"><i class="iconfont undefined"></i>
  系统教程
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/环境构建/" class="nav-link"><i class="iconfont undefined"></i>
  环境构建
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/K8S/" class="nav-link"><i class="iconfont undefined"></i>
  K8S
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/前端/" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/工具/" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/性能优化/" class="nav-link"><i class="iconfont undefined"></i>
  性能优化
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      文档
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/docs/theme-reco/" class="nav-link"><i class="iconfont undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基于 Node 的 DevOps 实战(三)———分析与设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/blogs/cicd/%E5%9F%BA%E4%BA%8ENode%E7%9A%84DevOps%E5%AE%9E%E6%88%98-%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/blogs/cicd/%E5%9F%BA%E4%BA%8ENode%E7%9A%84DevOps%E5%AE%9E%E6%88%98-%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1.html#项目分析" class="sidebar-link">项目分析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/blogs/cicd/%E5%9F%BA%E4%BA%8ENode%E7%9A%84DevOps%E5%AE%9E%E6%88%98-%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1.html#流程设计" class="sidebar-link">流程设计</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/blogs/cicd/%E5%9F%BA%E4%BA%8ENode%E7%9A%84DevOps%E5%AE%9E%E6%88%98-%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1.html#用户、权限系统设计" class="sidebar-link">用户、权限系统设计</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/blogs/cicd/%E5%9F%BA%E4%BA%8ENode%E7%9A%84DevOps%E5%AE%9E%E6%88%98-%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1.html#数据库设计" class="sidebar-link">数据库设计</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/blogs/cicd/%E5%9F%BA%E4%BA%8ENode%E7%9A%84DevOps%E5%AE%9E%E6%88%98-%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1.html#本章小结" class="sidebar-link">本章小结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-3dc17307 data-v-945f89ac><h3 class="title" style="display:none;" data-v-3dc17307 data-v-3dc17307>基于 Node 的 DevOps 实战(三)———分析与设计</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-3dc17307 data-v-3dc17307><input type="password" value="" data-v-3dc17307> <span data-v-3dc17307>Konck! Knock!</span> <button data-v-3dc17307>OK</button></label> <div class="footer" style="display:none;" data-v-3dc17307 data-v-3dc17307><span data-v-3dc17307><i class="iconfont reco-theme" data-v-3dc17307></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-3dc17307>vuePress-theme-reco</a></span> <span data-v-3dc17307><i class="iconfont reco-copyright" data-v-3dc17307></i> <a data-v-3dc17307><span data-v-3dc17307>jun</span>
            
          <span data-v-3dc17307>2017 - </span>
          2021
        </a></span></div></div> <div data-v-945f89ac><main class="page"><div class="page-title" style="display:none;"><h1>基于 Node 的 DevOps 实战(三)———分析与设计</h1> <hr> <div data-v-32e7eb69><i class="iconfont reco-account" data-v-32e7eb69><span data-v-32e7eb69>jun</span></i> <i class="iconfont reco-date" data-v-32e7eb69><span data-v-32e7eb69>2021-08-13 12:11:22</span></i> <i class="iconfont reco-eye" data-v-32e7eb69><span id="/blog/blogs/cicd/%E5%9F%BA%E4%BA%8ENode%E7%9A%84DevOps%E5%AE%9E%E6%88%98-%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-32e7eb69><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-32e7eb69><span class="tag-item" data-v-32e7eb69>Nodejs</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>通过前 2 章的内容，此时应该已经顺利的搭建了开发环境，也熟悉了服务器、shell 脚本的一些基本知识。</p> <p>通常开发项目之前，一般都会有 <a href="https://baike.baidu.com/item/%E4%BA%A7%E5%93%81%E9%9C%80%E6%B1%82%E6%96%87%E6%A1%A3/22740526?fromtitle=PRD&amp;fromid=11013752&amp;fr=aladdin" target="_blank" rel="noopener noreferrer">Prd（项目需求文档）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，会详细介绍项目中的需求模块、功能设计等各种细节内容，避免开发中出现缺陷，后期迭代或拓展困难。</p> <p>所以本章将会对整个项目进行需求分析与拆解，阅读本章你将会对工程化有进一步的了解，包括流程定制、Git Flew、权限设计、数据库建表等等。</p> <h2 id="项目分析"><a href="#项目分析" class="header-anchor">#</a> 项目分析</h2> <p>整个项目将分为 4 个学习模块，分别是：</p> <ul><li>服务端</li> <li>客户端</li> <li>CI/CD</li> <li>监控</li></ul> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9bd77dfbb3cc4c19ad2f4a786c864fe6~tplv-k3u1fbpfcp-watermark.image" alt="&quot;image.png&quot;"></p> <h4 id="大纲设计"><a href="#大纲设计" class="header-anchor">#</a> 大纲设计</h4> <ol><li>搭建一整套<code>开发-测试-构建-部署</code>的流程 --&gt; <strong>规范化流程</strong></li> <li>研发流程中加入<strong>能效概念</strong>（研发时间-测试时间-总体交付时间-bug 率及修复时间），作为项目提效的一个参考标准（影响因素太多，仅供参考） --&gt; <strong>流程闭环质量</strong></li> <li>合理的提测卡点，减少无效的提测，减轻测试负担 --&gt; <strong>简化交付成本</strong></li> <li>提供线上监控，分析每个版本使用率，报错率 --&gt; <strong>项目质量</strong></li> <li>提供快速回滚指定版本功能，确保新版本崩溃情况下能够<strong>快速恢复</strong>服务 --&gt; <strong>线上稳定性</strong></li></ol> <h4 id="devops-设计"><a href="#devops-设计" class="header-anchor">#</a> DevOps 设计</h4> <p>在小册大纲中，附图是一个较为完整的 DevOps 的项目架构设计，但作为一个实战的项目练习，个人独立完成所有的流程显然是比较困难。</p> <p>下图是简单版本的流程架构，整个项目将依照下图的简版流程进行开发。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8d0ea6e31dc40bc884b3983ea8c8f04~tplv-k3u1fbpfcp-zoom-1.image" alt="&quot;&quot;"></p> <h4 id="分析与拆解"><a href="#分析与拆解" class="header-anchor">#</a> 分析与拆解</h4> <p>根据流程图可以简单将 Node 模块分为 4 个部分</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0cdf5642584c4f479f37462dd4aee0f6~tplv-k3u1fbpfcp-watermark.image" alt="&quot;image.png&quot;"></p> <ol><li><p>用户模块</p> <ul><li>项目注册用户</li> <li>GitLab 授权第三方注册用户</li></ul></li> <li><p>角色模块</p> <ul><li>管理员</li> <li>测试</li> <li>开发</li></ul></li> <li><p>项目管理</p> <ul><li>项目（增删改查一套）</li> <li>打通 GitLab，通过 Open Api 关联项目并进行管理</li> <li>创建任务流，对整个项目进行追踪管理</li> <li>CICD 项目构建部分</li></ul></li> <li><p>线上监控（方案暂定）</p></li></ol> <p>后续将按照上述 4 个模块逐步开发，具体的细节部分会在每个模块开发中介绍。</p> <blockquote><p>GitLab 除了是一款优秀的代码仓库管理平台之外，本身也具备当一个小型项目管理系统的潜质，包含的项目、团队、权限、用户、issue 等等功能都已经非常完善。后续的工程将会非常依赖 GitLab，对 GitLab 提供的开放功能进行深度拓展，定制出合适的工程化体系。</p></blockquote> <h2 id="流程设计"><a href="#流程设计" class="header-anchor">#</a> 流程设计</h2> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f932a13c9bc64fd18bc84e98ec61d6ac~tplv-k3u1fbpfcp-zoom-1.image" alt="&quot;&quot;"></p> <p>如上图所示，将上述的发布流程更进一步的细化可以分为下面 4 类：</p> <ol><li>单项目发布流程（一个需求只需要一个工程完成）</li> <li>生产环境出问题，快速回滚功能</li> <li>集成项目发布流程（一个需求可能会有多个工程参与开发、发布）</li> <li>Bug 修复发布流程（无需求，需要快速修复线上已知但不紧急 bug 的发布流程）</li></ol> <blockquote><p>任务流的设计其实非常复杂，为了加快交付第一版，先将任务流固定为以上 4 类，可以减少开发量与难度，后期可以添加或者修改某个流程。</p></blockquote> <h4 id="git-flow-流程"><a href="#git-flow-流程" class="header-anchor">#</a> Git Flow 流程</h4> <p>Git Flow 的核心是通过在项目的不同阶段对 branch 的不同操作包括但不限于 create、marge、rebase 等来实现一个完整的高效率的工作流程。在项目的质量把控、多人协作中有非常好的实践。</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c5b691c99f3746fc967b0835227790f9~tplv-k3u1fbpfcp-zoom-1.image" alt="&quot;&quot;"></p> <ul><li><strong>Production 分支</strong></li></ul> <p>就是常用的 Master 分支，这个分支包含最近发布到生产环境的代码，最近发布的 Release， 这个分支只能从其他分支合并，不能在这个分支直接修改。</p> <ul><li><strong>Develop 分支</strong></li></ul> <p>这个分支是的主开发分支，包含所有要发布到下一个 Release 的代码，这个主要合并于其他分支，比如 Feature 分支。</p> <ul><li><strong>Feature 分支</strong></li></ul> <p>这个分支主要是用来开发一个新的功能，一旦开发完成，合并回 Develop 分支，并进入下一个 Release。</p> <ul><li><strong>Release 分支</strong></li></ul> <p>当需要发布一个新 Release 的时候，基于 Develop 分支创建一个 Release 分支，完成 Release 后，合并到 Master 和 Develop 分支。</p> <ul><li><strong>Hotfix 分支</strong></li></ul> <p>当在 Production 发现新的 Bug 时候，需要创建一个 Hotfix 分支, 完成修复后，合并回 Master 和 Develop 分支，所以 Hotfix 的改动会进入下一个 Release。</p> <p>整体的分支管理流程如下图所示</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e48ee7b35b684ceeb41b0ee2bf875bfa~tplv-k3u1fbpfcp-zoom-1.image" alt="&quot;&quot;"></p> <h4 id="项目自建流程"><a href="#项目自建流程" class="header-anchor">#</a> 项目自建流程</h4> <p>Git Flow 的优点非常明显，但在实际操作中，不能避免很多流程会有人工介入，有些环节不能完全约束与加入，所以在 Git Flow 的基础上再创建项目的自建流程，将 branch 与自建流程关联，可以对项目中的开发节点、发布节点、测试以及监控等流程与功能进行追踪。</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb27b54fe24c485ba062efabc82e0b3a~tplv-k3u1fbpfcp-zoom-1.image" alt="&quot;&quot;"></p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/632d2d88b95941f981d35c5281cbf93a~tplv-k3u1fbpfcp-zoom-1.image" alt="&quot;&quot;"></p> <p>如图每个工程都共享一个 Version 版本号，分支创建分为版本升级、特性更新、修订补丁三种模式，强制项目所有分支创建的命名规则都会升级，不会出现重复跟降级。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1bd83af2a5be4bb48a0f0404ce8f8c0f~tplv-k3u1fbpfcp-zoom-1.image" alt="&quot;&quot;"></p> <p><strong>上述流程的优点</strong>：</p> <ol><li>工程使用固定的版本锁死，版本对应需求流程，上线质量得到保障</li> <li>每个开发分支都只能部署到测试环境，必须合并到对应的版本分支之后才能上生产</li> <li>所有合并到 master 或者 relase 分支会被删除，防止一条分支处理过多业务，后期 review、回滚难度提升</li> <li>realse 版本分支上线之后，生成对应 tag</li> <li>hotfix 版本可以从对应的 tag 拉出，可以明确的知道 hotfix 具体修复的是哪个版本的问题</li></ol> <p><strong>上述流程的缺点</strong>：</p> <ol><li>固化版本流程导致创建命名规则固定，且版本号不能升级只能降级</li> <li>流程限制，降低开发灵活性</li></ol> <blockquote><p>没有完美的解决方法，所有 devops 流程都要结合真实项目需求来设计，上述也仅是其中一种解决方案</p></blockquote> <h2 id="用户、权限系统设计"><a href="#用户、权限系统设计" class="header-anchor">#</a> 用户、权限系统设计</h2> <h4 id="用户、权限方案"><a href="#用户、权限方案" class="header-anchor">#</a> 用户、权限方案</h4> <p>比较通用的用户信息表如下所示：</p> <ul><li>用户表（user）：<code>记录用户基本信息，不限于密码、用户名等</code></li> <li>权限表（permission）：<code>记录权限信息，例如增删改查各种权限</code></li> <li>角色表（role）：<code>记录角色信息，例如开发、测试、产品等各种角色</code></li> <li>用户 — 角色表（user_role）：<code>记录用户与角色关系表，有一对多的关系</code></li> <li>角色 — 权限表（role_permission）：<code>记录角色与权限的管理，有多对多的关系</code></li></ul> <p>更加复杂的用户权限设计可以加入用户组的概念，用户组级别的权限管理。</p> <p>如果全部都从头开发的话，估计直接劝退绝大部分的人了，整个项目的工程量会非常大，快速搭建一个可用的系统并不是一定要自己做完所有的事情，可以选择跟第三方系统对接。</p> <h4 id="第三方用户授权"><a href="#第三方用户授权" class="header-anchor">#</a> 第三方用户授权</h4> <ol><li><a href="https://developers.dingtalk.com/document/app/server-api-overview" target="_blank" rel="noopener noreferrer">钉钉企业用户<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://work.weixin.qq.com/api/doc/90000/90135/90664" target="_blank" rel="noopener noreferrer">企业微信用户<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>GitLab 用户关（后面会具体介绍）</li> <li>现在有内部系统提供用户与权限接口（对接企业自身内部系统）</li></ol> <p>以上可以互相搭配使用，比如内部用户系统接了钉钉或者企业微信的用户模块，然后通过邮箱关联一个 GitLab 账号，还是比较常见的做法。</p> <p>其实 GitLab 本身对于项目级别有了非常细致的权限管理，作为实战项目，可以简化用户系统，直接使用 GitLab 的用户、权限体系作为源数据。具体的流程可以参考下面的时序图</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39bb17e72c7c40499396e4516d24a901~tplv-k3u1fbpfcp-watermark.image" alt="&quot;image.png&quot;"></p> <h4 id="gitlab-权限"><a href="#gitlab-权限" class="header-anchor">#</a> GitLab 权限</h4> <p>通过 GitLab Api 获取项目信息的同时也能拿到该用户在对应项目中的 <code>permissions</code>，可以依赖 GitLab 自身对项目、团队做的权限做一个项目权限映射，极大的节约项目的开发时间与成本。</p> <p>GitLab 权限</p> <p>GitLab 权限描述</p> <p>access_level</p> <p>映射项目角色</p> <p>对应项目角色描述</p> <p>No access</p> <p>啥都不能干</p> <p>0</p> <p>无任何权限</p> <p><strong>啥都不能干</strong></p> <p>Guest</p> <p>创建issue、发表评论，不能读写版本库</p> <p>10</p> <p>项目经理</p> <p>可以查看项目进度</p> <p>Reporter</p> <p>克隆代码，不能提交</p> <p>20</p> <p>测试</p> <p>项目测试、提交 bug</p> <p>Developer</p> <p>克隆代码、开发、提交、push 等</p> <p>30</p> <p>开发</p> <p>项目开发，发布测试、预发环境</p> <p>Maintainer</p> <p>创建项目、添加tag、保护分支、添加项目成员、编辑项目等</p> <p>40</p> <p>管理者</p> <p>项目管理，发布生产环境</p> <p>Owner (Only valid to set for groups)</p> <p>设置项目访问权限、删除项目、迁移项目、管理组成员等</p> <p>50</p> <p>最高权限管理者</p> <p><strong>啥都能干</strong></p> <h2 id="数据库设计"><a href="#数据库设计" class="header-anchor">#</a> 数据库设计</h2> <h4 id="设计用户表"><a href="#设计用户表" class="header-anchor">#</a> 设计用户表</h4> <p>正常来说，第三方用户设计会有 3 张:</p> <p>表名</p> <p>描述</p> <p>user</p> <p>系统用户表</p> <p>social_account</p> <p>第三方用户表</p> <p>user_social_account</p> <p>系统与第三方用户关联表</p> <p>但根据上面的用户权限设计方案，GitLab 将作为底层数据来源，所以项目的 user 表可以直接跟 GitLab 的 social_account 表合并成为一章，包括用户 id 都可以直接使用 GitLab 的信息，保存一些常规不变的数据，可能会改变的数据可以直接从 GitLab 获取然后合并返回给业务即可。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6cf96be3c3d442c98722bf5f52fd420a~tplv-k3u1fbpfcp-watermark.image" alt="&quot;image.png&quot;"></p> <blockquote><p>这只是为了项目开发的速度而做的变通，实际情况中要根据自己的业务来设计用户表，自建用户的话，可以赋予更多自由度定制与功能拓展。</p></blockquote> <h4 id="设计业务表"><a href="#设计业务表" class="header-anchor">#</a> 设计业务表</h4> <p>根据上述的需求分析，先将最复杂的 project 与 branch 表结构设计出来，方便后期使用。</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9ea151d8b0d47df8f4998fb88fff520~tplv-k3u1fbpfcp-zoom-1.image" alt="&quot;&quot;"></p> <p>将 GitLab Project 与 Branch 字段与需要的数据落库到本地，再根据项目需求新增字段，大概的表结构如上图所示</p> <p>结合上述项目流程设计，说明一下表结构关系：</p> <ol><li>工程表 project 会管理多个分支 branch，可以查询当前工程下所有分支的状态（是否被提测，是否存在流程中）</li> <li>创建一个流程（等同于需求）关联多个 branch 开发</li> <li>流程创建完之后必走完所有步骤直至完结（<strong>开发-测试-预发-生产</strong>）</li> <li>当 branch 被一个流程关联之后，既被所<strong>锁定</strong>，不会再次被加入到其他流程（<strong>需求锁定隔离，保证开发过程不会有干扰</strong>）</li> <li>在流程的提测步骤中，可以针对不同 branch 进行多次提测（复杂需求通过<strong>分批提测</strong>，完成预期目标）</li> <li>当流程中所有 branch 的状态都已测试通过之后，该流程状态才进入下一个阶段，否则一直停留在测试阶段</li></ol> <blockquote><p>这里先简单介绍比较复杂的表结构，后续在开发过程中，会逐步介绍其他的表结构与设计。</p></blockquote> <h2 id="本章小结"><a href="#本章小结" class="header-anchor">#</a> 本章小结</h2> <p>本章是针对于整个项目的需求分析与设计，为了减少成本与时间，整个工程将依赖 GitLab 去开发。</p> <p>从下一章节开始，将正式进入 Node 项目的开发。</p> <p>如果你有什么疑问，欢迎在评论区提出，或者加群沟通。 👏</p></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-a008c6ba data-v-a008c6ba><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-a008c6ba><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-a008c6ba></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-a008c6ba></path></svg></div><div class="kanbanniang" data-v-ee8d62e6><div class="banniang-container" style="display:;" data-v-ee8d62e6><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-ee8d62e6>
      欢迎来到 jun的个人空间
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-ee8d62e6><i class="kbnfont kbn-ban-home ban-home" data-v-ee8d62e6></i> <i class="kbnfont kbn-ban-message message" data-v-ee8d62e6></i> <i class="kbnfont kbn-ban-close close" data-v-ee8d62e6></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-ee8d62e6><i class="kbnfont kbn-ban-info info" data-v-ee8d62e6></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:none;" data-v-ee8d62e6></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="position:fixed;left:0px;bottom:0px;opacity:0.9;z-index:99999;" data-v-ee8d62e6></canvas></div> <div class="showBanNiang" style="display:none;" data-v-ee8d62e6>
    看板娘
  </div></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/blog/assets/js/app.2e9aaf02.js" defer></script><script src="/blog/assets/js/3.df7e12f5.js" defer></script><script src="/blog/assets/js/1.71a2a4d1.js" defer></script><script src="/blog/assets/js/19.c7295ef8.js" defer></script>
  </body>
</html>
